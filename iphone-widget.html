<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üí∞ Despesas Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-container {
            width: 100%;
            max-width: 400px;
        }

        /* Widget Grande */
        .widget-large {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .widget-title {
            font-size: 18px;
            font-weight: 700;
            opacity: 0.9;
        }

        .widget-time {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Grid de KPIs */
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .kpi-card.featured {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.2);
        }

        .kpi-icon {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .kpi-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }

        .kpi-card.featured .kpi-value {
            font-size: 32px;
        }

        .kpi-subtitle {
            font-size: 10px;
            opacity: 0.7;
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        /* Divisor */
        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 16px 0;
        }

        /* Transa√ß√µes */
        .transactions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 12px;
        }

        .transactions-header {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-merchant {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .transaction-time {
            font-size: 10px;
            opacity: 0.6;
        }

        .transaction-amount {
            font-size: 14px;
            font-weight: 700;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 0;
            font-size: 16px;
        }

        /* Refresh button */
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s;
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Widget M√©dio */
        .widget-medium {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Widget Pequeno */
        .widget-small {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .widget-small .kpi-value {
            font-size: 28px;
        }
    </style>
</head>
<body>
    <button class="refresh-btn" onclick="loadData()" id="refreshBtn">‚Üª</button>
    
    <div class="widget-container" id="app">
        <div class="loading">‚è≥ Carregando...</div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO
        // ============================================
        const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx3AI8vmT4Oqu98qF8oSGLV6sdKYhh9DYuKKt6pu93R3Lr-m-F_s4XG2kuPu6K7bMGuqQ/exec';

        const state = {
            expenses: [],
            fixedExpenses: [],
            goal: 20000,
            goalFixed: 5000,
            loading: true
        };

        // ============================================
        // UTILIT√ÅRIOS
        // ============================================
        function formatAED(value) {
            if (value >= 1000) {
                return 'AED ' + (value / 1000).toFixed(1) + 'k';
            }
            return 'AED ' + value.toFixed(0);
        }

        function getMonthExpenses() {
            const now = new Date();
            return state.expenses.filter(e => {
                if (!e || !e.date) return false;
                const parts = e.date.toString().split('/');
                if (parts.length < 3) return false;
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                return month === now.getMonth() && year === now.getFullYear();
            });
        }

        function getTodayExpenses() {
            const now = new Date();
            const today = now.getDate();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            return state.expenses.filter(e => {
                if (!e || !e.date) return false;
                const parts = e.date.toString().split('/');
                if (parts.length < 3) return false;
                const day = parseInt(parts[0]);
                const eMonth = parseInt(parts[1]) - 1;
                const eYear = parseInt(parts[2]);
                return day === today && eMonth === month && eYear === year;
            }).sort((a, b) => {
                const timeA = a.time || '00:00:00';
                const timeB = b.time || '00:00:00';
                return timeB.localeCompare(timeA);
            });
        }

        function getDailyBudget() {
            const now = new Date();
            const monthExpenses = getMonthExpenses();
            const totalGastoMes = monthExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const totalFixas = state.fixedExpenses.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
            const limiteTotal = state.goal + state.goalFixed;
            const disponivelMes = limiteTotal - totalGastoMes - totalFixas;
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const daysRemaining = lastDayOfMonth - now.getDate() + 1;
            const budgetPerDay = daysRemaining > 0 ? disponivelMes / daysRemaining : 0;
            const todayExpenses = getTodayExpenses();
            const totalToday = todayExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const canSpendToday = budgetPerDay - totalToday;
            
            return {
                totalToday,
                budgetPerDay,
                canSpendToday,
                daysRemaining,
                disponivelMes,
                percentOfDailyBudget: budgetPerDay > 0 ? (totalToday / budgetPerDay) * 100 : 0
            };
        }

        // ============================================
        // CARREGAR DADOS
        // ============================================
        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            if (btn) btn.classList.add('spinning');
            
            state.loading = true;
            render();

            try {
                const expensesResponse = await fetch(`${SHEETS_URL}?action=getDespesas`);
                const expensesData = await expensesResponse.json();
                state.expenses = expensesData.expenses || [];

                const metaResponse = await fetch(`${SHEETS_URL}?action=getMeta`);
                const metaData = await metaResponse.json();
                state.goal = metaData.meta || 20000;
                state.goalFixed = metaData.metaFixed || 5000;

                try {
                    const fixedResponse = await fetch(`${SHEETS_URL}?action=getFixedExpenses`);
                    const fixedData = await fixedResponse.json();
                    state.fixedExpenses = fixedData.fixedExpenses || [];
                } catch (error) {
                    state.fixedExpenses = [];
                }

                state.loading = false;
                render();
            } catch (error) {
                state.loading = false;
                renderError(error.message);
            }
            
            if (btn) {
                setTimeout(() => btn.classList.remove('spinning'), 1000);
            }
        }

        // ============================================
        // RENDERIZAR
        // ============================================
        function render() {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = '<div class="loading">‚è≥ Carregando...</div>';
                return;
            }

            const monthExpenses = getMonthExpenses();
            const todayExpenses = getTodayExpenses();
            const dailyBudget = getDailyBudget();
            const totalVariaveis = monthExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const totalFixas = state.fixedExpenses.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
            const totalGeral = totalVariaveis + totalFixas;
            const limiteTotal = state.goal + state.goalFixed;
            const disponivel = limiteTotal - totalGeral;
            const percentGeral = limiteTotal > 0 ? (totalGeral / limiteTotal) * 100 : 0;

            let progressClass = '';
            if (percentGeral > 90) progressClass = 'danger';
            else if (percentGeral > 70) progressClass = 'warning';

            let dailyProgressClass = '';
            if (dailyBudget.percentOfDailyBudget > 100) dailyProgressClass = 'danger';
            else if (dailyBudget.percentOfDailyBudget > 80) dailyProgressClass = 'warning';

            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit'
            });

            app.innerHTML = `
                <!-- Widget Grande -->
                <div class="widget-large">
                    <div class="widget-header">
                        <div class="widget-title">üí∞ Despesas</div>
                        <div class="widget-time">${timeStr}</div>
                    </div>

                    <!-- KPI Hoje (Destaque) -->
                    <div class="kpi-card featured">
                        <div class="kpi-icon">üìÖ</div>
                        <div class="kpi-label">Hoje</div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">Gastei</div>
                                <div class="kpi-value">${formatAED(dailyBudget.totalToday)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">Posso gastar</div>
                                <div class="kpi-value" style="color: ${dailyBudget.canSpendToday >= 0 ? '#86efac' : '#fca5a5'};">
                                    ${formatAED(Math.abs(dailyBudget.canSpendToday))}
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${dailyProgressClass}" style="width: ${Math.min(dailyBudget.percentOfDailyBudget, 100)}%"></div>
                        </div>
                        <div class="kpi-subtitle" style="text-align: center; margin-top: 4px;">
                            ${dailyBudget.percentOfDailyBudget.toFixed(0)}% ‚Ä¢ ${todayExpenses.length} trans. ‚Ä¢ ${dailyBudget.daysRemaining} dias restantes
                        </div>
                    </div>

                    <!-- Grid KPIs -->
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-icon">üí∞</div>
                            <div class="kpi-label">Total M√™s</div>
                            <div class="kpi-value">${formatAED(totalGeral)}</div>
                            <div class="kpi-subtitle">${percentGeral.toFixed(0)}% usado</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-icon">‚úÖ</div>
                            <div class="kpi-label">Dispon√≠vel</div>
                            <div class="kpi-value" style="color: ${disponivel >= 0 ? '#86efac' : '#fca5a5'};">
                                ${formatAED(Math.abs(disponivel))}
                            </div>
                            <div class="kpi-subtitle">de ${formatAED(limiteTotal)}</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-icon">üí∏</div>
                            <div class="kpi-label">Vari√°veis</div>
                            <div class="kpi-value">${formatAED(totalVariaveis)}</div>
                            <div class="kpi-subtitle">${monthExpenses.length} trans.</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-icon">üí≥</div>
                            <div class="kpi-label">Fixas</div>
                            <div class="kpi-value">${formatAED(totalFixas)}</div>
                            <div class="kpi-subtitle">${state.fixedExpenses.length} fixas</div>
                        </div>
                    </div>

                    ${todayExpenses.length > 0 ? `
                        <div class="divider"></div>
                        <div class="transactions">
                            <div class="transactions-header">üïê √öltimas Transa√ß√µes</div>
                            ${todayExpenses.slice(0, 3).map(e => `
                                <div class="transaction-item">
                                    <div class="transaction-info">
                                        <div class="transaction-merchant">${e.merchant || 'Sem nome'}</div>
                                        <div class="transaction-time">${e.time || ''}</div>
                                    </div>
                                    <div class="transaction-amount">${formatAED(parseFloat(e.amount) || 0)}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderError(message) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="widget-large">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">Erro ao carregar</div>
                        <div style="font-size: 12px; opacity: 0.7;">${message}</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // INICIALIZAR
        // ============================================
        loadData();
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
